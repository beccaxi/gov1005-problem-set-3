---
title: "Gov1005 Problem Set 3"
author: "Rebecca Xi"
date: "2/19/2020"
output: html_document
---

## Getting Data into R
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# I took a cue from 2/13 class in determining which libraries to load

library(readr)
library(janitor)
library(dplyr)
library(gt)
library(tidyverse)
```

```{r data, include=FALSE}

# As in 2/13 class, I set skip = 3 and moved the descriptive information
# (authors) for the dataset in those lines into a subtitle for a cleaner look. 
# I used the argument na within read_csv() to replace all missing and undefined
# values with NA before using clean_names() from the janitor library.

csv <- read_csv(file = "raw-data/xian_data.csv",
                skip = 3,
                na = c("", "undefined")) %>% 
  clean_names()
  
# I used gt(), as in 2/13 class, for a nice presentation of the data and to
# label the columns with their actual metric descriptors (which I found from
# looking at the research on Harvard HOLLIS)
  
csv %>%
  gt() %>%
    tab_header(
      title = "Bread and Circuses: Sports and Public Opinion in China",
      subtitle = "Dan Chen and Andrew W. MacDonald"
    ) %>%
    cols_label(
      respondent = "Respondent",
      location = "Location", 
      news_source = "News Source",
      eval_gov_overall = "Satisfaction with local government overall",
      eval_gov_demo = "Satisfaction with local government on the issue of
      demolition and relocation",
      eval_gov_traffic = "Satisfaction with local government on the issue 
      of traffic congestion",
      #treatment = "Treatment",
      control = "Control"
    )
```

  
## Mad Libs

```{r Mad Libs 1, include=FALSE}

# I call sum() to aggregate the values of the column "treatment", which 
# returns the number of respondents in the Treatment group since each such 
# respondent corresponds to a value of 1

r1 <- csv %>%
  summarize(sum(treatment))
```

1. `r r1` respondents are in the treatment group.


```{r Mad Libs 2, include=FALSE}

# I call mean() to find the average (overall) government rating, filtering for
# responses from the treatment group only

r2 <- csv %>%
  filter(treatment == 1) %>% 
  summarize(mean(eval_gov_overall, na.rm = TRUE))
```

2. Among respondents from the treatment group, the government has an average 
`r r2` rating.


```{r Mad Libs 3, include=FALSE}

# This line creates a table called "temp", where the first row is a sorted list
# of all unique values in the argument (csv$eval_gov_traffic). The second row in
# temp counts how many occurrences of each value. So this method is a nice way
# of finding the mode of a column, since a mode() function doesn't exist
# directly.

temp <- table(as.vector(csv$eval_gov_traffic))
  
# This line returns the numerical value with the highest count in second row of
# temp (i.e. the mode)
  
r3 <- names(temp)[temp == max(temp)]
```

3. The most common rating for the government’s handling of traffic is `r r3`.


```{r Mad Libs 4, include=FALSE}

# Filter first through values of THREE columns, before counting the desired rows
# to get the appropriate number of respondents. I'm assuming the statement is an
# "and/or" statement that selects respondents who gave 1, 2, or 3 ratings of 10.

r4 <- csv %>%
  filter(eval_gov_overall == 10 | eval_gov_demo == 10 | eval_gov_traffic == 10) %>% 
  count()
```

4. `r r4` respondents have given the government a 10 rating overall or on 
demolitions or on traffic.


```{r Mad Libs 5, include=FALSE}

# Just like in the last one, except switch out the "or" indicators for "and"
# indicators before counting the filtered rows

r5 <- csv %>%
  filter(eval_gov_overall == 10 & eval_gov_demo == 10 & eval_gov_traffic == 10) %>% 
  count()
```

5. But only `r r5` gave the government a 10 rating overall and on demolitions 
and on traffic.


The variable ‘news_source’ asks respondents to list which news sources they 
get their news from. Some respondents answered more than one option, so their 
answer lists a number of letters together. A means “Television”, B means 
“Newspapers”, C means “Radio”, etc

```{r Mad Libs 6, include=FALSE}

# We're interested in (pure) Television viewers so we simply filter for A in 
# the news_source column

r6 <- csv %>%
  filter(news_source == "A") %>% 
  count()
```

6. The number of respondents who get their news from Television is `r r6`.


```{r Mad Libs 7, include=FALSE}

library(stringr)

# 

r7 <- csv %>% 
  filter(str_detect(location, "square")) %>% 
  count(location) %>% 
  select(location) %>% 
  slice(1)

r8 <- csv %>% 
  filter(str_detect(location, "square")) %>% 
  count(location) %>% 
  select(location) %>% 
  slice(2)
```

7. Of the 4 different locations where the respondents were surveyed, the 
following two locations end with “square”: `r r7`, `r r8`.


## Data Wrangling

### 1. 

```{r data 1, echo=FALSE, message=FALSE, warning=FALSE}

library(tidyr)

#

untidy <- read_csv(file = "raw-data/xian_data.csv",
                skip = 3,
                na = c("", "undefined")) %>% 
  clean_names() %>% 
  select(respondent, eval_gov_overall, eval_gov_traffic, eval_gov_demo) %>% 
  slice(1:10)

# 
  
untidy %>%
  gt() %>%
    tab_header(title = "Untidy Data") %>%
    tab_spanner(label = "Evaluations of Government Performance",
                columns = vars(
                  eval_gov_overall, 
                  eval_gov_demo, 
                  eval_gov_traffic
                )
    ) %>% 
    cols_label(
      respondent = "Respondent Number",
      eval_gov_overall = "Overall",
      eval_gov_demo = "Demolitions",
      eval_gov_traffic = "Traffic"
    ) %>% 
    cols_move_to_end(columns = vars(eval_gov_demo))

#

tidy <- untidy %>% 
  rename(
    Overall = eval_gov_overall,
    Traffic = eval_gov_traffic,
    Demo = eval_gov_demo
  ) %>% 
  pivot_longer(
    names_to = "Type of Evaluation",
    values_to = "Performance Rating",
    cols = c(Overall, Traffic, Demo)
  )

tidy %>% 
  gt() %>% 
    tab_header(title = "Tidy Data") %>% 
    cols_label(respondent = "Respondent Number")
    
```


### 2.

```{r data 2, echo=FALSE, message=FALSE}

# Let's re-read the file in to start on a clean slate, assigning it to
# "outcomes" now

outcomes <- read_csv(file = "raw-data/xian_data.csv",
                skip = 3,
                na = c("", "undefined")) %>% 
  clean_names() %>% 
  slice(1:10)

# This is to change the treatment and control columns into 
  
outcomes %>% 
  mutate(
    under_control = ifelse(treatment == 0, eval_gov_overall, "?"),
    under_treatment = ifelse(treatment == 1, eval_gov_overall, "?")
  ) %>%
  select(respondent, treatment, control, under_control, under_treatment) %>% 
  gt() %>%
    tab_header(title = "Potential Outcomes") %>%
    tab_spanner(label = "Potential Outcomes",
                columns = vars(
                  under_control,
                  under_treatment
                )
    ) %>% 
    cols_label(
      respondent = "Respondent",
      treatment = "Treatment",
      control = "Control",
      under_treatment = "Under Treatment",
      under_control = "Under Control"
    ) %>% 
  cols_align(align = c("center"), columns = TRUE) %>% 
  tab_footnote(
    footnote = "Treatment is a 2 minute video about Chinese sports performance",
    locations = cells_title("title")
  )
```


### 3.

```{r data 3, echo=FALSE, message=FALSE}

#

load("r-data/demographics.Rdata")

#

joined <- csv %>% 
  full_join(demographics, by = "respondent")

#
  
joined %>% 
  filter(treatment == 1) %>% 
  arrange(desc(eval_gov_traffic)) %>%
  select(respondent, eval_gov_traffic, age, gender) %>% 
  slice(1:5) %>% 
  gt() %>% 
    tab_header(
      title = "Highest Evaluators of Government Performance on Traffic:",
      subtitle = "Among Treated Individuals"
    ) %>% 
    cols_label(
      respondent = "Respondent",
      eval_gov_traffic = "Evaluate Government Performance",
      age = "Age",
      gender = "Gender"
    ) %>% 
    tab_footnote(
      footnote = "Evaluation on Scale from 1 to 10",
      locations = cells_title("title")
    )
```


### 4.

```{r data 4, echo=FALSE, message=FALSE}

#

joined$education <- fct_relevel(
  joined$education, 
  "Primary", 
  "Incomplete secondary", 
  "Complete secondary", 
  "Some university"
)

#

plot <- joined %>% 
  na.omit() %>% 
  mutate(treatment = factor(treatment)) %>% 
  select(respondent, education, treatment, control, eval_gov_overall) %>% 
  group_by(education, treatment, control) %>% 
  summarize(avg = mean(as.numeric(eval_gov_overall), na.rm = TRUE)) 

#

plot %>% 
  ggplot(aes(x = education, y = avg, color = treatment)) +
    geom_point() +
    theme(
      panel.background = element_rect(fill = "white"),
      axis.line = element_line(size = 0.5, color = "black"),
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "top",
      legend.key = element_rect(fill = "transparent")
    ) +
    labs(
      title = "Government Performance Evaluations \n By Treatment Group \n and Education Level",
      x = "Education",
      y = "Average Evaluation",
      color = "Viewed Sports Video"
    ) 

```


### 5.

```{r data 5, echo=FALSE, message=FALSE}

# The rvest package allows us to work with XML and specifically HTML documents

library(rvest)

# We read the source html of the Wikipedia page and store it in h

h <- read_html("https://en.wikipedia.org/wiki/2008_Summer_Olympics#Medal_table")

# We know we're looking for a table, so we feed the results of html_nodes() 
# into tab and convert the HTML tables into data frames for much easier viewing 
# and handling later on.

tab <- h %>% 
  html_nodes("table") %>% 
  html_table(fill = TRUE) 

# When we view the contents of tab, we notice that the 
# one we're interested in (country gold medals) is [] in the list of data 
# frames, so we extract that one.

tab <- tab[[8]]
  
#




```


## Colleagues


* Lara Teich

* Ishan Bhaat

* Grace Pan

* Stephanie Cheng

* Rachel Phan

* Sophie Webster

* Lainey Newman


